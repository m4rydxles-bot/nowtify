<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nowtify</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <i class="fas fa-music"></i>
                Nowtify
            </div>
            <div class="nav-links">
                <a href="./dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#" id="profile-link"><i class="fas fa-user"></i> Profil</a>
                <a href="./settings.html"><i class="fas fa-cog"></i> Ayarlar</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Merhaba, <span id="username"></span></h1>
            <p>Spotify hesabını bağla ve müzik dinlemeye başla</p>
        </div>

        <div id="success-message" class="success-message" style="display: none;"></div>

        <div class="cards-grid">
            <div class="card">
                <h3><i class="fab fa-spotify"></i> Spotify Bağlantısı</h3>
                <p id="spotify-status">Spotify hesabın bağlı değil</p>
                <button id="connect-spotify-btn" class="btn btn-primary">
                    <i class="fab fa-spotify"></i>
                    Spotify'a Bağlan
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-share-alt"></i> Profil Paylaşımı</h3>
                <p>Profil linkin:</p>
                <input type="text" id="profile-url" readonly style="width: 100%; padding: 8px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); margin-top: 8px; font-size: 12px;">
                <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="copyProfileUrl()">
                    <i class="fas fa-copy"></i>
                    Linki Kopyala
                </button>
            </div>
        </div>

        <div id="now-playing-section" style="display: none;">
            <h2 style="margin-top: 32px; margin-bottom: 16px; font-size: 18px;">
                <i class="fas fa-play-circle"></i> Şu Anda Çalıyor
            </h2>
            <div class="now-playing" id="now-playing"></div>
        </div>

        <div style="margin-top: 32px;">
            <h2 style="margin-bottom: 16px; font-size: 18px;">
                <i class="fas fa-history"></i> Dinleme Geçmişi
            </h2>
            <div class="history-list" id="history-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: var(--text-secondary);">Yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="./utils.js"></script>
    <script>
        requireAuth();

        const user = getCurrentUser();
        document.getElementById('username').textContent = user.username;
        document.getElementById('profile-link').href = `./profile.html?user=${user.username}`;
        document.getElementById('profile-url').value = `${window.location.origin}/profile.html?user=${user.username}`;

        if (getUrlParameter('spotify_connected') === 'true') {
            showSuccess('Spotify başarıyla bağlandı!');
            setTimeout(() => hideMessage('success-message'), 5000);
        }

        async function loadUserData() {
            try {
                const data = await apiRequest('/api/auth/me');
                
                if (data.user.spotify_connected) {
                    document.getElementById('spotify-status').innerHTML = '<i class="fas fa-check-circle"></i> Bağlı';
                    document.getElementById('connect-spotify-btn').innerHTML = '<i class="fab fa-spotify"></i> Bağlantıyı Yenile';
                    pollNowPlaying();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        document.getElementById('connect-spotify-btn').addEventListener('click', async () => {
            try {
                const data = await apiRequest('/api/spotify/login');
                window.location.href = data.auth_url;
            } catch (error) {
                alert('Spotify bağlantı hatası: ' + error.message);
            }
        });

        let nowPlayingInterval;
        async function pollNowPlaying() {
            async function checkNowPlaying() {
                try {
                    const data = await apiRequest('/api/spotify/now-playing');
                    if (data && data.item) {
                        displayNowPlaying(data);
                    }
                } catch (error) {
                    console.error('Error fetching now playing:', error);
                }
            }

            checkNowPlaying();
            nowPlayingInterval = setInterval(checkNowPlaying, 3000);
        }

        function displayNowPlaying(data) {
            const section = document.getElementById('now-playing-section');
            const container = document.getElementById('now-playing');
            
            section.style.display = 'block';
            container.innerHTML = `
                <img src="${data.item.album.images[0].url}" alt="Album Art" class="album-art">
                <div class="track-info">
                    <h2>${data.item.name}</h2>
                    <p class="artist">${data.item.artists.map(a => a.name).join(', ')}</p>
                    <p style="color: var(--text-secondary); margin-top: 8px; font-size: 13px;">${data.item.album.name}</p>
                </div>
            `;
        }

        async function loadHistory() {
            try {
                const data = await apiRequest(`/api/users/${user.username}/history`);
                const historyList = document.getElementById('history-list');
                
                if (data.history && data.history.length > 0) {
                    historyList.innerHTML = data.history.map(track => `
                        <div class="history-item">
                            <img src="${track.album_image || '/img/placeholder.png'}" alt="Album">
                            <div class="history-item-info">
                                <h4>${track.track_name}</h4>
                                <p>${track.artist_name} • ${formatDate(track.played_at)}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 32px;">Henüz dinleme geçmişin yok</p>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('history-list').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 32px;">Geçmiş yüklenirken hata oluştu</p>';
            }
        }

        function copyProfileUrl() {
            const input = document.getElementById('profile-url');
            input.select();
            document.execCommand('copy');
            alert('Profil linki kopyalandı!');
        }

        loadUserData();
        loadHistory();
        setInterval(loadHistory, 30000);
    </script>
</body>
</html>
